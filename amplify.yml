version: 1
backend:
  phases:
    build:
      commands:
        # AWS Amplify Gen 2 Official Pattern: Generate amplify_outputs.json during build
        - echo "ğŸ”§ Generating environment-specific amplify_outputs.json"
        - |
          if [ "$AWS_BRANCH" = "main" ]; then
            echo "ğŸ“ Development environment (main branch)"
            npx ampx generate outputs --app-id d3atadjk90y9q5 --branch main
          elif [ "$AWS_BRANCH" = "staging" ]; then
            echo "ğŸ“ Staging environment (staging branch - shares dev backend)"
            npx ampx generate outputs --app-id d3atadjk90y9q5 --branch main
          elif [ "$AWS_BRANCH" = "prod" ]; then
            echo "ğŸ“ Legacy staging environment (prod branch - shares dev backend)"
            npx ampx generate outputs --app-id d3atadjk90y9q5 --branch main
          elif [ "$AWS_BRANCH" = "production" ]; then
            echo "ğŸ“ Production environment (production branch - isolated backend)"
            npx ampx pipeline-deploy --branch production --app-id d200k2wsaf8th3
          else
            echo "âš ï¸  Unknown branch: $AWS_BRANCH, using development config"
            npx ampx generate outputs --app-id d3atadjk90y9q5 --branch main
          fi
        - echo "âœ… Environment-specific amplify_outputs.json generated"
frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸ“¦ Installing dependencies"
        - npm ci
        - echo "ğŸ” Verifying amplify_outputs.json exists"
        - |
          if [ ! -f "amplify_outputs.json" ]; then
            echo "âŒ ERROR: amplify_outputs.json not found after backend phase"
            exit 1
          fi
        - echo "âœ… Configuration verified - branch: $AWS_BRANCH"
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
    discard-paths: false
  cache:
    paths:
      - node_modules/**/*