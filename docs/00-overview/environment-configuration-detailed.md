# Environment Configuration Guide - Three-Environment Architecture

## Overview

RealTechee 2.0 uses a sophisticated three-environment architecture with AWS Amplify Gen 2, providing complete isolation between local development, staging, and production environments. This guide documents the exact configuration and precedence chain for environment variables.

## Architecture Summary

### Three Distinct Environments

| Environment | Backend Type | Configuration Source | Backend Suffix |
|-------------|--------------|---------------------|----------------|
| **Local Development** | Local Sandbox | `.env.development.local` | `fvn7t5hbobaxjklhrqzdl4ac34` |
| **Staging** | AWS Amplify Server-Built | AWS Amplify Default Variables | `irgzwsfnba3sfqtum5k2eyp4m` |
| **Production** | AWS Amplify Server-Built | AWS Amplify Branch Override | `yk6ecaswg5aehj3ev76xzpbe` |

### Key Architectural Principles

1. **Complete Backend Isolation**: Each environment has its own DynamoDB tables, Lambda functions, and Cognito user pools
2. **Server-Side Generation**: Staging and production backends are built during AWS Amplify deployment
3. **Local Sandbox Flexibility**: Development uses ephemeral local backend for rapid iteration
4. **Environment Variable Inheritance**: Sophisticated precedence chain ensures correct configuration

## Environment Variable Precedence Chain

AWS Amplify follows this **exact precedence order** (higher priority overrides lower):

```
1. AWS Amplify Environment Variables (All branches - DEFAULT)
   ↓ (overridden by if exists)
2. AWS Amplify Branch-Specific Environment Variables  
   ↓ (overridden by if exists)
3. .env.staging / .env.production files (committed to repository)
   ↓ (overridden by if exists) 
4. .env.staging.local / .env.production.local files (local overrides, gitignored)
   ↓ (backend deployment)
5. Backend built with resolved environment variables (ampx pipeline deploy)
```

## Current AWS Amplify Console Configuration

### Default Environment Variables (All Branches)

**Applied to**: All branches unless overridden  
**Points to**: Staging backend infrastructure

```bash
AMPLIFY_APP_ID=d200k2wsaf8th3
API_KEY=da2-xvy7iayc7hpigk6tyv5evfw3i
BACKEND_SUFFIX=irgzwsfnba3sfqtum5k2eyp4m
GRAPHQL_URL=https://xcl73f4ymzdbr06xcvw72jnzr3a.appsync-api.us-west-1.amazonaws.com/graphql
IDENTITY_POOL_ID=us-west-1:231b7978-2f9b-458d-8345-a922f2c3e018
S3_BUCKET=amplify-d200k2wsaf8th3-st-realtecheeuseruploadsbuc-lollpnfn8hd5
USER_POOL_CLIENT_ID=13buiopad6u8rfl9p5fhi5vcc4
USER_POOL_ID=us-west-1_NeGfFuVD7
NODE_ENV=staging
```

### Production Branch Override

**Applied to**: `production` branch only  
**Points to**: Production backend infrastructure

```bash
API_KEY=da2-wwiaod7ylfb7fl3xejucyfbf4y
BACKEND_SUFFIX=yk6ecaswg5aehj3ev76xzpbe
GRAPHQL_URL=https://lwcozitcrzervozzmgsvaqal5j.appsync-api.us-west-1.amazonaws.com/graphql
IDENTITY_POOL_ID=us-west-1:52b0fc80-b01f-4109-9f25-dc1a9c81d430
S3_BUCKET=amplify-d200k2wsaf8th3-pr-realteecheuseruploadsbuc-u5mq35hrcrmj
USER_POOL_CLIENT_ID=792b3vwu4or3pk0oemerbiunm36
USER_POOL_ID=us-west-1_Ukszk3SGQb
NODE_ENV=production
```

## Local Development Configuration

### .env.development.local (Local Sandbox)

**Location**: `/Users/doron/Projects/RealTechee 2.0/.env.development.local`  
**Git Status**: Ignored (not committed)  
**Points to**: Local sandbox backend

```bash
# Local development environment variables
NEXT_PUBLIC_BACKEND_SUFFIX=fvn7t5hbobaxjklhrqzdl4ac34
NEXT_PUBLIC_ENVIRONMENT=development

# Sandbox-specific configuration
# (Other variables generated by ampx sandbox)
```

## Environment-Specific Build Process

### Local Development Process

```
1. Developer runs: npx ampx sandbox --watch
   ↓
2. Local backend stack created with suffix: fvn7t5hbobaxjklhrqzdl4ac34
   ↓
3. amplify_outputs.json generated pointing to local resources
   ↓
4. .env.development.local provides environment-specific overrides
   ↓
5. Next.js dev server connects to local backend infrastructure
```

### Staging Deployment Process

```
1. Code pushed to staging branch
   ↓
2. AWS Amplify checkout + environment variable resolution
   ↓
3. Default environment variables applied (staging backend)
   ↓
4. Backend deployment: ampx pipeline deploy (staging suffix)
   ↓ 
5. amplify_outputs.json generated server-side
   ↓
6. Frontend build with staging backend configuration
   ↓
7. Deploy to: staging.d200k2wsaf8th3.amplifyapp.com
```

### Production Deployment Process

```
1. Code pushed to production branch
   ↓
2. AWS Amplify checkout + environment variable resolution
   ↓
3. Default variables + production branch overrides applied
   ↓
4. Backend deployment: ampx pipeline deploy (production suffix)
   ↓
5. amplify_outputs.json generated server-side with production config
   ↓
6. Frontend build with production backend configuration
   ↓
7. Deploy to: production.d200k2wsaf8th3.amplifyapp.com
```

## Backend Resource Isolation

### Database Tables by Environment

#### Local Development Tables
**Pattern**: `TableName-fvn7t5hbobaxjklhrqzdl4ac34-NONE`

```
Examples:
- Contact-fvn7t5hbobaxjklhrqzdl4ac34-NONE
- Property-fvn7t5hbobaxjklhrqzdl4ac34-NONE
- Project-fvn7t5hbobaxjklhrqzdl4ac34-NONE
- Request-fvn7t5hbobaxjklhrqzdl4ac34-NONE
```

#### Staging Tables
**Pattern**: `TableName-irgzwsfnba3sfqtum5k2eyp4m-NONE`

```
Examples:
- Contact-irgzwsfnba3sfqtum5k2eyp4m-NONE
- Property-irgzwsfnba3sfqtum5k2eyp4m-NONE
- Project-irgzwsfnba3sfqtum5k2eyp4m-NONE
- Request-irgzwsfnba3sfqtum5k2eyp4m-NONE
```

#### Production Tables  
**Pattern**: `TableName-yk6ecaswg5aehj3ev76xzpbe-NONE`

```
Examples:
- Contact-yk6ecaswg5aehj3ev76xzpbe-NONE
- Property-yk6ecaswg5aehj3ev76xzpbe-NONE
- Project-yk6ecaswg5aehj3ev76xzpbe-NONE
- Request-yk6ecaswg5aehj3ev76xzpbe-NONE
```

### Lambda Functions by Environment

#### Local Development
- **Pattern**: Local Lambda execution (ampx sandbox)
- **Isolation**: Complete local execution environment

#### Staging  
- **Pattern**: `amplify-realtecheeclone-st-{functionname}-{hash}`
- **Examples**: Notification processors, status handlers, etc.

#### Production
- **Pattern**: `amplify-realtecheeclone-pr-{functionname}-{hash}`  
- **Examples**: Notification processors, status handlers, etc.

### Cognito User Pools by Environment

#### Local Development
- **User Pool ID**: Generated by sandbox (ephemeral)
- **Client ID**: Generated by sandbox (ephemeral)

#### Staging
- **User Pool ID**: `us-west-1_NeGfFuVD7`
- **Client ID**: `13buiopad6u8rfl9p5fhi5vcc4`

#### Production  
- **User Pool ID**: `us-west-1_Ukszk3SGQb`
- **Client ID**: `792b3vwu4or3pk0oemerbiunm36`

## Environment Variable Validation

### Verification Commands by Environment

#### Local Development Verification
```bash
# Check sandbox backend connection
npx ampx sandbox --once
cat amplify_outputs.json | jq '.data.url'

# Verify local environment
node -e "console.log('Backend Suffix:', process.env.NEXT_PUBLIC_BACKEND_SUFFIX)"
```

#### Staging Environment Verification  
```bash
# Check staging deployment
curl -s https://staging.d200k2wsaf8th3.amplifyapp.com/api/system/env

# AWS CLI verification
aws dynamodb list-tables --region us-west-1 | grep irgzwsfnba3sfqtum5k2eyp4m
```

#### Production Environment Verification
```bash
# Check production deployment  
curl -s https://production.d200k2wsaf8th3.amplifyapp.com/api/system/env

# AWS CLI verification
aws dynamodb list-tables --region us-west-1 | grep yk6ecaswg5aehj3ev76xzpbe
```

## Troubleshooting Environment Issues

### Common Environment Variable Problems

#### 1. Wrong Backend Suffix
**Symptom**: Application points to wrong environment
**Diagnosis**: Check browser console environment display
**Solution**: Verify AWS Amplify Console environment variables

#### 2. Local Sandbox Not Working
**Symptom**: Local development fails to connect
**Diagnosis**: Check `amplify_outputs.json` generation
**Solution**: Restart sandbox with `npx ampx sandbox --once`

#### 3. Staging/Production Mismatch
**Symptom**: Deployment points to wrong backend
**Diagnosis**: Check AWS Amplify deployment logs
**Solution**: Verify branch-specific environment variable overrides

### Environment Debugging Commands

```bash
#!/bin/bash
# Complete environment debugging script

echo "=== Environment Debugging Report ==="

echo "1. Local Development Check"
if [ -f ".env.development.local" ]; then
    echo "✅ Local env file exists"
    grep BACKEND_SUFFIX .env.development.local
else
    echo "❌ Local env file missing"
fi

echo "2. AWS Amplify App Check"
aws amplify get-app --app-id d200k2wsaf8th3 --query 'app.environmentVariables'

echo "3. Current DynamoDB Tables"
aws dynamodb list-tables --region us-west-1 | grep -E "(Contact|Property|Project|Request)"

echo "4. Amplify Branches"
aws amplify list-branches --app-id d200k2wsaf8th3 --query 'branches[].{Name:branchName,Status:stage}'
```

## Security & Best Practices

### Environment Variable Security

1. **Never commit credentials**: Use AWS Amplify Console for sensitive variables
2. **Local override files**: Keep `.env.*.local` files gitignored
3. **Principle of least privilege**: Each environment only accesses its resources
4. **Regular rotation**: Rotate API keys and secrets according to security policy

### Development Best Practices

1. **Local first**: Always develop and test locally before pushing
2. **Environment validation**: Verify correct backend connection after deployment
3. **Data isolation**: Never use production data in development/staging
4. **Clean separation**: Keep environment-specific logic minimal and well-documented

## Related Documentation

- **[AWS Amplify Gen 2 Complete Guide](../06-deployment/aws-amplify-gen2-complete-guide.md)** - Complete deployment procedures
- **[Environment Variable Troubleshooting](../07-operations/environment-variable-troubleshooting.md)** - Detailed troubleshooting procedures
- **[Node.js Production Dependencies Guide](../04-implementation/nodejs-production-dependencies-guide.md)** - Dependency management across environments
- **[AMPLIFY_ENV_PLAN.md](../../AMPLIFY_ENV_PLAN.md)** - Original three-environment architecture planning document
- **[Session Infrastructure Optimization](../10-appendices/session-amplify-infrastructure-optimization.md)** - Infrastructure improvements and dependency resolution

---

**Last Updated**: August 14, 2025  
**Version**: 4.2.2  
**Status**: Production Ready - Complete Three-Environment Architecture ✅